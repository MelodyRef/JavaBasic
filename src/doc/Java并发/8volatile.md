### 8.1volatile的内存定义

 volatile关键字主要有两个功能


- 保证变量的内存可见性（线程间的内存可见性，一个线程修改了共享变量后，其他线程可以读取这个修改后的值）
- 禁止volatile变量与普通变量重排序（指令的重新排序）



当一个线程对volatile变量进行写操作后，JMM会立即将该线程对应的本地内存中共享变量的值刷新到主内存中；对一个volatile变量读操作时会将该线程对应本地内存设置为无效并去主内存中读取共享变量的值



### 8.2禁止重排序

JVM通过**内存屏障**来实现禁止重排序

内存屏障分为读屏障和写屏障，内存屏障有两个作用：

1. 阻止屏障两侧的指令重排序
2. 强制把写缓冲区/高速缓存（主要指CPU缓存）中的脏数据等写回到主内存，或者让缓冲中相应的数据失效

编译器在**生成字节码**时，会在指令序列中插入内存屏障来禁止特定类型的处理器重排序。编译器选择了一个**比较保守的JMM内存屏障插入策略**，可以保证在任何处理器平台，任何程序中都能得到正确的volatile内存语义

- 在每个volatile写操作前插入一个StoreStore屏障
- 在每个volatile写作从后插入一个StoreLoad屏障
- 在每个volatile读操作后插入一个LoadLoad屏障
- 在每个volatile读操作后再插入一个LoadStore屏障



1. 第一个操作是volatile读则不会与之后的任何操作重排序
2. 第二个操作是volatile写，无论第一个操作是什么都不会重排序
3. 第一个volatile写，第二个volatile读，不能重排序

